<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>휘슬 STAT 관리</title>
  <!-- (기존 스타일 전체 유지 - 생략 가능) -->
  <style>
    /* 💡 기존 CSS는 동일하므로 생략합니다. */
  </style>
</head>
<body>
  <div class="container">
    <!-- ... 상단 구성 동일 ... -->
    <!-- 경기 수, 승률, 득점, 득실차는 고정 수치가 아닌 JS에서 계산하도록 할 수도 있음 -->
    
    <!-- 선수별 통계 / 경기 결과 영역 -->
    <div class="main-content">
      <div class="section">
        <div class="section-title">선수별 통계</div>
        <div class="filter-controls">
          <button class="filter-btn active" onclick="filterPlayers('all')">전체</button>
          <button class="filter-btn" onclick="filterPlayers('goals')">골 순</button>
          <button class="filter-btn" onclick="filterPlayers('attendance')">참석률 순</button>
          <button class="filter-btn" onclick="filterPlayers('mvp')">MVP 횟수</button>
        </div>
        <div class="table-container">
          <table class="players-table">
            <thead>
              <tr>
                <th>이름</th>
                <th>출전</th>
                <th>참석률</th>
                <th>골</th>
                <th>MVP</th>
              </tr>
            </thead>
            <tbody id="playersTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <div class="section-title">최근 경기 결과</div>
        <div class="table-container">
          <table class="matches-table">
            <thead>
              <tr>
                <th>날짜</th>
                <th>상대</th>
                <th>결과</th>
                <th>스코어</th>
                <th>MVP</th>
              </tr>
            </thead>
            <tbody id="matchesTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 다음 경기 일정 및 지도 섹션 동일 -->
  </div>

  <!-- 스크립트 영역 -->
  <script>
    let matches = [];
    let playerStats = {};
    let currentFilter = 'all';

    function updatePlayersTable() {
      const tbody = document.getElementById('playersTableBody');
      tbody.innerHTML = '';

      let playersArray = Object.entries(playerStats).map(([name, stats]) => ({
        name,
        ...stats,
        attendanceRate: ((stats.appearances / matches.length) * 100).toFixed(1)
      }));

      switch (currentFilter) {
        case 'goals':
          playersArray.sort((a, b) => b.goals - a.goals);
          break;
        case 'attendance':
          playersArray.sort((a, b) => b.attendanceRate - a.attendanceRate);
          break;
        case 'mvp':
          playersArray.sort((a, b) => b.mvp - a.mvp);
          break;
        default:
          playersArray.sort((a, b) => a.name.localeCompare(b.name));
      }

      playersArray.forEach(player => {
        let rateClass = 'rate-low';
        if (player.attendanceRate >= 70) rateClass = 'rate-high';
        else if (player.attendanceRate >= 50) rateClass = 'rate-medium';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${player.name}</td>
          <td>${player.appearances}</td>
          <td><span class="attendance-rate ${rateClass}">${player.attendanceRate}%</span></td>
          <td>${player.goals}</td>
          <td>${player.mvp > 0 ? `<span class="mvp-badge">${player.mvp}회</span>` : '0'}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateMatchesTable() {
      const tbody = document.getElementById('matchesTableBody');
      tbody.innerHTML = '';

      matches.slice(0, 15).forEach(match => {
        let resultClass = 'result-loss';
        let resultText = '패';
        if (match.result === 'win') {
          resultClass = 'result-win';
          resultText = '승';
        } else if (match.result === 'draw') {
          resultClass = 'result-draw';
          resultText = '무';
        }

        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="white-space: nowrap;">${match.date}</td>
          <td>${match.opponent}</td>
          <td><span class="result-badge ${resultClass}">${resultText}</span></td>
          <td>${match.score}</td>
          <td>${match.mvp ? `<span class="mvp-badge">${match.mvp}</span>` : ''}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function filterPlayers(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      updatePlayersTable();
    }

    async function loadData() {
      try {
        const response = await fetch('match_data.json');
        const data = await response.json();
        matches = data.matches;
        playerStats = data.players;

        updatePlayersTable();
        updateMatchesTable();
      } catch (error) {
        console.error('⚠️ 데이터 로딩 실패:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      setTimeout(loadKakaoMap, 3000); // 기존 지도 로딩
    });

    function loadKakaoMap() {
      const script = document.createElement('script');
      script.src = 'https://dapi.kakao.com/v2/maps/sdk.js?appkey=47eed652b004605d8a8e3e39df268f24&autoload=false&libraries=services';
      script.onload = () => {
        kakao.maps.load(() => {
          const mapContainer = document.getElementById('map-placeholder');
          mapContainer.innerHTML = '<div id="map" style="width:100%;height:300px;border-radius:8px;border:2px solid #1e40af;"></div>';

          const map = new kakao.maps.Map(document.getElementById('map'), {
            center: new kakao.maps.LatLng(37.4656, 127.0347),
            level: 3
          });

          const geocoder = new kakao.maps.services.Geocoder();
          const address = '서울특별시 구로구 고척로45길 37';

          geocoder.addressSearch(address, (result, status) => {
            if (status === kakao.maps.services.Status.OK) {
              const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
              map.setCenter(coords);
              const marker = new kakao.maps.Marker({ map, position: coords });
              const infowindow = new kakao.maps.InfoWindow({
                content: '<div style="padding:5px;font-size:12px;text-align:center;">고척근린공원 축구장</div>'
              });
              infowindow.open(map, marker);
            } else {
              document.getElementById('map').innerHTML = `<div style="text-align:center;color:#666;">주소 검색 실패: ${status}</div>`;
            }
          });
        });
      };
      script.onerror = () => {
        console.error('카카오맵 로드 실패');
        document.getElementById('map-placeholder').innerHTML = `<div>지도를 불러올 수 없습니다</div>`;
      };
      document.head.appendChild(script);
    }
  </script>
</body>
</html>
