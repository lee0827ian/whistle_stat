<!DOCTYPE html>

<html lang="ko">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>휘슬 STAT 관리</title>

    <style>

        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

        }

        

        body {

            font-family: 'Arial', sans-serif;

            background: linear-gradient(90deg, #1e3a8a, #3b82f6, #60a5fa, #fbbf24, #f59e0b);

            min-height: 100vh;

            padding: 20px;

        }

        

        .container {

            max-width: 1400px;

            margin: 0 auto;

            background: rgba(255, 255, 255, 0.95);

            border-radius: 20px;

            padding: 30px;

            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);

        }

        

        .header {

            text-align: center;

            margin-bottom: 40px;

            padding-bottom: 20px;

            border-bottom: 3px solid #1e40af;

        }

        

        .team-name {

            font-size: 2.5em;

            color: #1e40af;

            margin-bottom: 10px;

            font-weight: bold;

        }

        

        .season-selector {

            margin-bottom: 0;

            display: flex;

            justify-content: center;

            align-items: center;

            gap: 15px;

        }



        .season-selector select {

            padding: 12px 20px;

            border: 3px solid #1e40af;

            border-radius: 25px;

            font-size: 1.1em;

            font-weight: bold;

            color: #1e40af;

            background: linear-gradient(135deg, #ffffff, #f8fafc);

            cursor: pointer;

            min-width: 160px;

            text-align: center;

            box-shadow: 0 4px 15px rgba(30, 64, 175, 0.15);

            transition: all 0.3s ease;

            outline: none;

            appearance: none;

            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%231e40af" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>');

            background-repeat: no-repeat;

            background-position: right 15px center;

            background-size: 12px;

            padding-right: 45px;

        }



        .season-selector select:hover {

            background: linear-gradient(135deg, #f8fafc, #e2e8f0);

            box-shadow: 0 6px 20px rgba(30, 64, 175, 0.25);

            transform: translateY(-2px);

        }



        .season-selector select:focus {

            border-color: #3b82f6;

            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);

        }



        .all-time-button {

            padding: 12px 24px;

            border: 3px solid #f59e0b;

            border-radius: 25px;

            font-size: 1.1em;

            font-weight: bold;

            color: #f59e0b;

            background: linear-gradient(135deg, #ffffff, #fefbf1);

            cursor: pointer;

            min-width: 120px;

            text-align: center;

            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.15);

            transition: all 0.3s ease;

            outline: none;

            border: none;

            display: flex;

            align-items: center;

            justify-content: center;

            gap: 8px;

        }



        .all-time-button:hover {

            background: linear-gradient(135deg, #fefbf1, #fef3c7);

            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.25);

            transform: translateY(-2px);

        }



        .all-time-button.active {

            background: linear-gradient(135deg, #f59e0b, #d97706);

            color: white;

            border-color: #d97706;

        }



        .all-time-button.active:hover {

            background: linear-gradient(135deg, #d97706, #b45309);

        }

        

        .status-message {

            margin: 15px 0;

            padding: 12px 20px;

            border-radius: 8px;

            text-align: center;

            font-weight: 500;

            display: none;

        }

        

        .status-loading {

            background: #eff6ff;

            color: #1e40af;

            border: 2px solid #dbeafe;

        }

        

        .status-error {

            background: #fef2f2;

            color: #dc2626;

            border: 2px solid #fecaca;

        }

        

        .status-success {

            background: #f0fdf4;

            color: #16a34a;

            border: 2px solid #bbf7d0;

        }

        

        .season {

            display: none;

        }

        

        .stats-overview {

            display: grid;

            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));

            gap: 20px;

            margin-bottom: 40px;

        }

        

        .stat-card {

            background: linear-gradient(135deg, #1e40af, #60a5fa);

            padding: 25px;

            border-radius: 15px;

            color: white;

            text-align: center;

        }

        

        .stat-title {

            font-size: 1.2em;

            margin-bottom: 15px;

            font-weight: bold;

        }

        

        .stat-value {

            font-size: 2.5em;

            font-weight: bold;

            margin-bottom: 5px;

        }

        

        .stat-subtitle {

            font-size: 0.9em;

            opacity: 0.9;

        }

        

        .main-content {

            display: grid;

            grid-template-columns: 1fr 1fr;

            gap: 30px;

            margin-bottom: 40px;

        }

        

        .all-time-content {

            display: grid;

            grid-template-columns: 1fr 1fr;

            gap: 30px;

            margin-bottom: 40px;

        }

        

        .section {

            background: #f8f9fa;

            padding: 25px;

            border-radius: 15px;

            height: 580px;

            display: flex;

            flex-direction: column;

        }

        

        /* 역대기록 탭에서 높이 증가 */

        .all-time-view .section {

            height: 750px;

        }

        

        .team-records-section {

            background: #f8f9fa;

            padding: 25px;

            border-radius: 15px;

            height: 580px;

            display: flex;

            flex-direction: column;

            overflow-y: auto;

        }

        

        /* 역대기록 탭에서 팀 기록 섹션 높이 증가 */

        .all-time-view .team-records-section {

            height: 750px;

        }

        

        .section-title {

            font-size: 1.5em;

            color: #1e40af;

            margin-bottom: 20px;

            font-weight: bold;

            text-align: center;

        }

        

        .players-table, .matches-table {

            width: 100%;

            border-collapse: collapse;

            margin-top: 15px;

        }

        

        .players-table th, .players-table td, .matches-table th, .matches-table td {

            padding: 10px;

            text-align: left;

            border-bottom: 1px solid #ddd;

            font-size: 0.9em;

        }

        

        .players-table th, .matches-table th {

            background: #1e40af;

            color: white;

            font-weight: bold;

            position: sticky;

            top: 0;

        }

        

        .players-table tr:hover, .matches-table tr:hover {

            background: #f5f5f5;

        }

        

        .attendance-rate {

            padding: 3px 8px;

            border-radius: 4px;

            font-weight: bold;

            color: white;

            font-size: 0.8em;

        }

        

        .rate-high {

            background: #1e40af;

        }

        

        .rate-medium {

            background: #fbbf24;

            color: #333;

        }

        

        .rate-low {

            background: #dc3545;

        }

        

        .mvp-badge {

            background: #fbbf24;

            color: #333;

            padding: 2px 6px;

            border-radius: 3px;

            font-size: 0.7em;

            font-weight: bold;

            white-space: nowrap;

            display: inline-block;

            max-width: 100%;

            overflow: hidden;

            text-overflow: ellipsis;

        }

        

        .season-mvp-badge {

            background: #fbbf24;

            color: #333;

            padding: 4px 12px;

            border-radius: 8px;

            font-size: 1.2em;

            font-weight: bold;

            display: inline-block;

            margin-top: 5px;

        }

        

        .result-badge {

            padding: 3px 8px;

            border-radius: 4px;

            font-weight: bold;

            color: white;

            font-size: 0.8em;

        }

        

        .result-win {

            background: #1e40af;

        }

        

        .result-draw {

            background: #fbbf24;

            color: #333;

        }

        

        .result-loss {

            background: #dc3545;

        }

        

        .table-container {

            flex: 1;

            overflow-y: auto;

            border-radius: 8px;

            border: 1px solid #ddd;

        }

        

        .team-record-card {

            margin-bottom: 15px;

            padding: 15px;

            border-radius: 12px;

            text-align: center;

            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);

            min-height: 120px;

        }

        

        /* 누적 기록 카드 개선 */

        .team-record-overall {

            background: linear-gradient(135deg, #fbbf24, #f59e0b);

            color: #1e293b;

            min-height: 140px;

        }



        .team-record-win-streak {

            background: linear-gradient(135deg, #10b981, #34d399);

            color: white;

        }

        

        .team-record-loss-streak {

            background: linear-gradient(135deg, #f43f5e, #fb7185);

            color: white;

        }

        

        .team-record-max-goals {

            background: linear-gradient(135deg, #06b6d4, #22d3ee);

            color: white;

        }

        

        .team-record-max-conceded {

            background: linear-gradient(135deg, #ef4444, #f87171);

            color: white;

        }

        

        .team-record-best-season {

            background: linear-gradient(135deg, #fbbf24, #f59e0b);

            color: #1e293b;

        }

        

        .team-record-worst-season {

            background: linear-gradient(135deg, #6b7280, #9ca3af);

            color: white;

        }

        

        .team-record-title {

            font-size: 1.0em;

            font-weight: bold;

            margin-bottom: 8px;

        }

        

        .team-record-value {

            font-size: 1.8em;

            font-weight: bold;

            margin-bottom: 6px;

        }

        

        .team-record-detail {

            font-size: 0.85em;

            opacity: 0.9;

        }

        

        .next-matches-section {

            background: #f8f9fa;

            padding: 25px;

            border-radius: 15px;

            margin-top: 60px;

            border-top: 2px solid #e9ecef;

        }

        

        /* 역대기록 탭에서 다음 경기 섹션 숨김 */

        .all-time-view .next-matches-section {

            display: none;

        }

        

        .schedule-and-map {

            display: grid;

            grid-template-columns: 1fr 1fr;

            gap: 30px;

            margin-top: 20px;

        }

        

        .schedule-container {

            background: white;

            padding: 20px;

            border-radius: 10px;

            box-shadow: 0 2px 8px rgba(0,0,0,0.1);

        }

        

        .schedule-item {

            background: linear-gradient(135deg, #1e40af, #60a5fa);

            color: white;

            border-radius: 12px;

            padding: 20px;

            margin: 10px 0;

            text-align: center;

        }

        

        .schedule-date {

            font-weight: bold;

            font-size: 1.3em;

            margin-bottom: 8px;

        }

        

        .schedule-time-venue {

            font-size: 1.1em;

            margin-bottom: 12px;

            opacity: 0.95;

        }

        

        .schedule-opponent {

            font-size: 1.4em;

            font-weight: bold;

            letter-spacing: 1px;

        }

        

        .map-container {

            background: white;

            padding: 20px;

            border-radius: 10px;

            box-shadow: 0 2px 8px rgba(0,0,0,0.1);

            text-align: center;

        }

        

        #map {

            width: 100%;

            height: 300px;

            border-radius: 8px;

            border: 2px solid #1e40af;

        }

        

        .map-placeholder {

            width: 100%;

            height: 300px;

            background: #e9ecef;

            border-radius: 8px;

            display: flex;

            align-items: center;

            justify-content: center;

            color: #1e40af;

            font-size: 1.1em;

            border: 2px dashed #1e40af;

            flex-direction: column;

        }

        

        .venue-info {

            margin-top: 15px;

            text-align: left;

        }

        

        .venue-name {

            font-weight: bold;

            color: #1e40af;

            font-size: 1.2em;

            margin-bottom: 5px;

        }

        

        .venue-address {

            color: #666;

            font-size: 0.9em;

            margin-bottom: 5px;

        }

        

        .venue-phone {

            color: #666;

            font-size: 0.9em;

        }

        

        .filter-controls {

            margin-bottom: 15px;

            display: flex;

            gap: 10px;

            flex-wrap: wrap;

        }

        

        .filter-btn {

            padding: 8px 15px;

            border: 2px solid #1e40af;

            background: white;

            color: #1e40af;

            border-radius: 20px;

            cursor: pointer;

            font-size: 0.9em;

            transition: all 0.3s;

        }

        

        .filter-btn.active {

            background: #1e40af;

            color: white;

        }

        

        .no-data {

            text-align: center;

            color: #666;

            font-style: italic;

            padding: 20px;

        }

        

        .all-time-highlight {

            background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;

        }



        .rank-medal {

            font-size: 1.2em;

            margin-left: 5px;

        }



        /* 로딩 프로그레스 바 */

        .loading-progress {

            margin: 10px 0;

            height: 4px;

            background: #e2e8f0;

            border-radius: 2px;

            overflow: hidden;

            display: none;

        }



        .loading-progress-bar {

            height: 100%;

            background: linear-gradient(90deg, #1e40af, #3b82f6);

            transition: width 0.3s ease;

            width: 0%;

        }



        .loading-stats {

            font-size: 0.9em;

            color: #666;

            text-align: center;

            margin-top: 5px;

        }

        

        @media (max-width: 768px) {

            .container {

                padding: 15px;

            }



            .season-selector {

                flex-direction: column;

                gap: 10px;

            }



            .season-selector select,

            .all-time-button {

                min-width: 140px;

                font-size: 1em;

                padding: 10px 15px;

            }

            

            .main-content, .all-time-content {

                grid-template-columns: 1fr;

            }

            

            .schedule-and-map {

                grid-template-columns: 1fr;

            }

            

            .stats-overview {

                grid-template-columns: repeat(2, 1fr);

            }

            

            .team-name {

                font-size: 2em;

            }

            

            .players-table th, .players-table td, .matches-table th, .matches-table td {

                padding: 6px 4px;

                font-size: 0.75em;

            }

            

            .mvp-badge {

                font-size: 0.65em;

                padding: 1px 4px;

                max-width: 60px;

            }

            

            .players-table th:nth-child(1), .players-table td:nth-child(1) {

                width: 20%;

            }

            

            .players-table th:nth-child(2), .players-table td:nth-child(2) {

                width: 15%;

            }

            

            .players-table th:nth-child(3), .players-table td:nth-child(3) {

                width: 20%;

            }

            

            .players-table th:nth-child(4), .players-table td:nth-child(4) {

                width: 15%;

            }

            

            .players-table th:nth-child(5), .players-table td:nth-child(5) {

                width: 30%;

            }

            

            .matches-table th:nth-child(1), .matches-table td:nth-child(1) {

                width: 18%;

                white-space: nowrap;

                font-size: 0.7em;

            }

            

            .matches-table th:nth-child(2), .matches-table td:nth-child(2) {

                width: 22%;

            }

            

            .matches-table th:nth-child(3), .matches-table td:nth-child(3) {

                width: 12%;

            }

            

            .matches-table th:nth-child(4), .matches-table td:nth-child(4) {

                width: 18%;

            }

            

            .matches-table th:nth-child(5), .matches-table td:nth-child(5) {

                width: 30%;

            }

            

            .section, .team-records-section {

                height: auto;

                padding: 15px;

            }

            

            .next-matches-section {

                margin-top: 40px;

                padding: 15px;

            }

            

            .schedule-item {

                padding: 15px;

                margin: 15px 0;

            }

            

            .schedule-date {

                font-size: 1.2em;

            }

            

            .schedule-time-venue {

                font-size: 1em;

            }

            

            .schedule-opponent {

                font-size: 1.3em;

            }

            

            .filter-controls {

                gap: 5px;

            }

            

            .filter-btn {

                padding: 6px 12px;

                font-size: 0.8em;

            }

            

            #map, .map-placeholder {

                height: 250px;

            }

        }

        

        @media (max-width: 480px) {

            .stats-overview {

                grid-template-columns: 1fr;

                gap: 15px;

            }

            

            .stat-card {

                padding: 20px;

            }

            

            .schedule-item {

                padding: 12px;

            }

            

            .schedule-date {

                font-size: 1.1em;

            }

            

            .schedule-opponent {

                font-size: 1.2em;

            }

            

            .season-selector select,

            .all-time-button {

                min-width: 120px;

                font-size: 0.9em;

                padding: 8px 12px;

            }

            

            .players-table th, .players-table td, .matches-table th, .matches-table td {

                padding: 4px 2px;

                font-size: 0.7em;

            }

            

            .mvp-badge {

                font-size: 0.6em;

                padding: 1px 3px;

                max-width: 50px;

            }

        }

    </style>

</head>

<body>

    <div class="container">

        <div class="header">

            <div class="team-name">WHISTLE</div>

            <div class="season-selector">

                <select id="seasonSelect" onchange="changeSeason()" onclick="onSeasonSelectClick()">

                    <option value="2025">🏆 2025 시즌</option>

                    <option value="2024">2024 시즌</option>

                    <option value="2023">2023 시즌</option>

                    <option value="2022">2022 시즌</option>

                    <option value="2021">2021 시즌</option>

                    <option value="2020">2020 시즌</option>

                    <option value="2019">2019 시즌</option>

                    <option value="2018">2018 시즌</option>

                    <option value="2017">2017 시즌</option>

                    <option value="2016">2016 시즌</option>

                    <option value="2015">2015 시즌</option>

                    <option value="2014">2014 시즌</option>

                    <option value="2013">2013 시즌</option>

                    <option value="2012">2012 시즌</option>

                    <option value="2011">2011 시즌</option>

                    <option value="2010">2010 시즌</option>

                    <option value="2009">2009 시즌</option>

                    <option value="2008">2008 시즌</option>

                    <option value="2007">2007 시즌</option>

                    <option value="2006">2006 시즌</option>

                    <option value="2005">2005 시즌</option>

                    <option value="2004">2004 시즌</option>

                    <option value="2003">2003 시즌</option>

                    <option value="2002">2002 시즌</option>

                    <option value="2001">2001 시즌</option>

                    <option value="2000">2000 시즌</option>                   

                </select>

                <button id="allTimeButton" class="all-time-button" onclick="toggleAllTimeView()">

                    📊 역대 기록

                </button>

            </div>

            <div id="statusMessage" class="status-message"></div>

            <div id="loadingProgress" class="loading-progress">

                <div id="loadingProgressBar" class="loading-progress-bar"></div>

            </div>

            <div id="loadingStats" class="loading-stats"></div>

        </div>



        <div class="stats-overview">

            <div class="stat-card">

                <div class="stat-title">경기 수</div>

                <div class="stat-value" id="totalMatches">0</div>

                <div class="stat-subtitle">총 경기</div>

            </div>

            <div class="stat-card">

                <div class="stat-title">승률</div>

                <div class="stat-value" id="winRate">0%</div>

                <div class="stat-subtitle" id="winRateSubtitle">0승 0무 0패</div>

            </div>

            <div class="stat-card">

                <div class="stat-title">득점</div>

                <div class="stat-value" id="totalGoals">0</div>

                <div class="stat-subtitle" id="goalsPerMatch">경기당 0골</div>

            </div>

            <div class="stat-card">

                <div class="stat-title" id="mvpCardTitle">시즌 MVP</div>

                <div class="stat-value" id="seasonMvp">-</div>

                <div class="stat-subtitle" id="mvpStats">MVP 0회</div>

            </div>

        </div>



        <div id="mainContent" class="main-content">

            <div class="section">

                <div class="section-title">선수별 통계</div>

                <div class="filter-controls">

                    <button class="filter-btn active" data-filter="all" onclick="filterPlayers('all')">전체</button>

                    <button class="filter-btn" data-filter="goals" onclick="filterPlayers('goals')">골 순</button>

                    <button class="filter-btn" data-filter="attendance" onclick="filterPlayers('attendance')">참석률 순</button>

                    <button class="filter-btn" data-filter="mvp" onclick="filterPlayers('mvp')">MVP 횟수</button>

                </div>

                <div class="table-container">

                    <table class="players-table">

                        <thead>

                            <tr id="playersTableHeader">

                                <th>이름</th>

                                <th>출전</th>

                                <th>참석률</th>

                                <th>골</th>

                                <th>MVP</th>

                            </tr>

                        </thead>

                        <tbody id="playersTableBody">

                            <tr><td colspan="5" class="no-data">데이터를 불러오는 중...</td></tr>

                        </tbody>

                    </table>

                </div>

            </div>



            <div class="section" id="matchesSection">

                <div class="section-title">최근 경기 결과</div>

                <div class="table-container">

                    <table class="matches-table">

                        <thead>

                            <tr>

                                <th>날짜</th>

                                <th>상대</th>

                                <th>결과</th>

                                <th>스코어</th>

                                <th>MVP</th>

                            </tr>

                        </thead>

                        <tbody id="matchesTableBody">

                            <tr><td colspan="5" class="no-data">데이터를 불러오는 중...</td></tr>

                        </tbody>

                    </table>

                </div>

            </div>

        </div>



        <div id="allTimeContent" class="all-time-content" style="display: none;">

            <div class="section">

                <div class="section-title">역대 선수 기록</div>

                <div class="filter-controls">

                    <button class="filter-btn active" data-filter="all" onclick="filterPlayers('all')">전체</button>

                    <button class="filter-btn" data-filter="goals" onclick="filterPlayers('goals')">골 순</button>

                    <button class="filter-btn" data-filter="attendance" onclick="filterPlayers('attendance')">참석률 순</button>

                    <button class="filter-btn" data-filter="mvp" onclick="filterPlayers('mvp')">MVP 횟수</button>

                </div>

                <div class="table-container">

                    <table class="players-table">

                        <thead>

                            <tr id="allTimePlayersTableHeader">

                                <th>이름</th>

                                <th>총 출장</th>

                                <th>총 득점</th>

                                <th>총 MVP</th>

                            </tr>

                        </thead>

                        <tbody id="allTimePlayersTableBody">

                            <tr><td colspan="4" class="no-data">데이터를 불러오는 중...</td></tr>

                        </tbody>

                    </table>

                </div>

            </div>



            <div class="team-records-section">

                <div class="section-title">역대 팀 기록</div>

                <div id="teamRecordsContainer">

                    <!-- 팀 기록 카드들이 여기에 동적으로 추가됩니다 -->

                </div>

            </div>

        </div>

 

        <!-- 다음 경기 일정 및 구장 위치 -->

        <div class="next-matches-section">

            <div class="section-title">다음 경기 일정 및 구장 위치</div>

            <div class="schedule-and-map">

                <div class="schedule-container">

                    <h3 style="color: #1e40af; margin-bottom: 15px;">다음 경기 일정</h3>

                    <div class="schedule-item">

                        <div class="schedule-date">8월 10일 (일) 12:00</div>

                        <div class="schedule-time-venue">고척근린공원</div>

                        <div class="schedule-opponent">VS AGAIN FC</div>

                    </div>

                </div>

                <div class="map-container">

                    <h3 style="color: #1e40af; margin-bottom: 15px;">구장위치</h3>

                    <div id="map-placeholder" class="map-placeholder">

                        🗺️<br>고척근린공원<br>

                        <small>지도 로딩 중...</small>

                    </div>

                    <div class="venue-info">

                        <div class="venue-name">고척근린공원 축구장</div>

                        <div class="venue-address">📍 서울특별시 구로구 고척로45길 37</div>

                        <div class="venue-phone">📞 주차 요금은 5분당 150원, 1시간에 1,800원</div>

                    </div>

                </div>

            </div>

        </div>

    </div>



    <script>

        // ========== 설정 ========== 

        const CONFIG = {

            AVAILABLE_SEASONS: ['2000','2001','2002','2003','2004','2005','2006','2007','2008','2009','2010','2011','2012','2013','2014','2015','2016','2017','2018','2019', '2020', '2021', '2022', '2023', '2024', '2025'],

            DEFAULT_SEASON: '2025',

            KAKAO_MAP_API_KEY: '47eed652b004605d8a8e3e39df268f24',

            VENUE: {

                name: '감일축구장',

                address: '경기 하남시 감이동 465',

                info: '전화번호: 031-790-2022, 주차 편함'

            },

            NEXT_MATCH: {

                date: '9월 7일 (일) 15:00',

                venue: '감일축구장',

                opponent: 'VS FC 포텐'

            },

            PARALLEL_LOADING: {

                BATCH_SIZE: 5, // 한 번에 로드할 시즌 수

                MAX_CONCURRENT: 3 // 최대 동시 요청 수

            }

        };



        // ========== 전역 변수 ==========

        let currentSeason = CONFIG.DEFAULT_SEASON;

        let isAllTimeView = false;

        let matches = [];

        let playerStats = {};

        let currentFilter = 'all';

        let mapScriptLoaded = false;

        let mapInitialized = false;

        let currentAbortController = null;

        

        // 한국어 정렬을 위한 Collator

        const koreanCollator = new Intl.Collator('ko', { numeric: true });



        // ========== 보안 및 유틸리티 함수 ==========

        function escapeHtml(unsafe) {

            return unsafe

                .replace(/&amp;/g, "&amp;amp;")

                .replace(/&lt;/g, "&amp;lt;")

                .replace(/&gt;/g, "&amp;gt;")

                .replace(/"/g, "&amp;quot;")

                .replace(/'/g, "&amp;#039;");

        }



        function sanitizeTableData(data) {

            if (typeof data === 'string') {

                return escapeHtml(data);

            }

            return data;

        }



        // ========== 상태 메시지 관리 ==========

        function showStatusMessage(message, type = 'loading') {

            const statusElement = document.getElementById('statusMessage');

            statusElement.textContent = message;

            statusElement.className = `status-message status-${type}`;

            statusElement.style.display = 'block';

        }



        function hideStatusMessage() {

            const statusElement = document.getElementById('statusMessage');

            statusElement.style.display = 'none';

        }



        function showLoadingProgress(current, total, message = '') {

            const progressContainer = document.getElementById('loadingProgress');

            const progressBar = document.getElementById('loadingProgressBar');

            const statsElement = document.getElementById('loadingStats');

            

            progressContainer.style.display = 'block';

            const percentage = Math.round((current / total) * 100);

            progressBar.style.width = `${percentage}%`;

            

            if (message) {

                statsElement.textContent = `${message} (${current}/${total})`;

                statsElement.style.display = 'block';

            }

        }



        function hideLoadingProgress() {

            const progressContainer = document.getElementById('loadingProgress');

            const statsElement = document.getElementById('loadingStats');

            

            progressContainer.style.display = 'none';

            statsElement.style.display = 'none';

        }



        // ========== 데이터 검증 ==========

        function validateSeasonData(data) {

            const validatedData = {

                matches: [],

                players: {}

            };



            if (Array.isArray(data.matches)) {

                validatedData.matches = data.matches.filter(match => {

                    return match && 

                           typeof match.date === 'string' &&

                           typeof match.opponent === 'string' &&

                           typeof match.result === 'string' &&

                           typeof match.score === 'string' &&

                           ['win', 'draw', 'loss'].includes(match.result) &&

                           /^\d+:\d+$/.test(match.score);

                }).map(match => ({

                    date: sanitizeTableData(match.date),

                    opponent: sanitizeTableData(match.opponent),

                    result: match.result,

                    score: match.score,

                    mvp: sanitizeTableData(match.mvp || '')

                }));

            }



            if (data.players && typeof data.players === 'object') {

                Object.entries(data.players).forEach(([name, stats]) => {

                    if (typeof name === 'string' && stats && typeof stats === 'object') {

                        validatedData.players[sanitizeTableData(name)] = {

                            appearances: Math.max(0, parseInt(stats.appearances) || 0),

                            goals: Math.max(0, parseInt(stats.goals) || 0),

                            mvp: Math.max(0, parseInt(stats.mvp) || 0)

                        };

                    }

                });

            }



            return validatedData;

        }



        // ========== MVP 선정 함수 (개선됨) ==========

        function calculateSeasonMvp(playerStats) {

            if (!playerStats || Object.keys(playerStats).length === 0) {

                return null;

            }

            

            const playersArray = Object.entries(playerStats)

                .map(([name, stats]) => ({ name, ...stats }))

                .filter(player => player.appearances > 0); // 출장한 선수만 고려

            

            if (playersArray.length === 0) {

                return null;

            }

            

            // MVP 선정 기준: 1) MVP 횟수 2) 참가횟수

            playersArray.sort((a, b) => {

                if (b.mvp !== a.mvp) return b.mvp - a.mvp;

                if (b.appearances !== a.appearances) return b.appearances - a.appearances;

                return koreanCollator.compare(a.name, b.name);

            });

            

            return playersArray[0];

        }



        // ========== UI 상태 관리 (개선됨) ==========

        function updateButtonStates() {

            const allTimeButton = document.getElementById('allTimeButton');

            const seasonSelect = document.getElementById('seasonSelect');

            const container = document.querySelector('.container');

            

            if (isAllTimeView) {

                allTimeButton.classList.add('active');

                seasonSelect.style.opacity = '0.6';

                container.classList.add('all-time-view');

            } else {

                allTimeButton.classList.remove('active');

                seasonSelect.style.opacity = '1';

                container.classList.remove('all-time-view');

            }

        }



        function onSeasonSelectClick() {

            if (isAllTimeView) {

                setTimeout(() => {

                    changeSeason();

                }, 10);

            }

        }



        // ========== 병렬 데이터 로딩 (개선됨) ==========

        async function loadSeasonDataWithRetry(season, retries = 2) {

            let lastError = null;

            

            for (let i = 0; i <= retries; i++) {

                try {

                    const controller = new AbortController();

                    const timeoutId = setTimeout(() => controller.abort(), 8000); // 8초 타임아웃

                    

                    const response = await fetch(`${season}_data.json`, {

                        signal: controller.signal,

                        headers: {

                            'Cache-Control': 'no-cache',

                            'Accept': 'application/json'

                        }

                    });

                    

                    clearTimeout(timeoutId);

                    

                    if (!response.ok) {

                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);

                    }

                    

                    const rawData = await response.json();

                    return { season, data: validateSeasonData(rawData), success: true };

                    

                } catch (error) {

                    lastError = error;

                    if (error.name === 'AbortError') {

                        console.warn(`${season} 로딩 타임아웃 (시도 ${i + 1}/${retries + 1})`);

                    } else {

                        console.warn(`${season} 로딩 실패 (시도 ${i + 1}/${retries + 1}):`, error.message);

                    }

                    

                    if (i < retries) {

                        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1))); // 지수 백오프

                    }

                }

            }

            

            return { season, data: null, success: false, error: lastError };

        }



        async function loadAllTimeSeasonsParallel() {

            const allTimeStats = {};

            const allMatches = [];

            const seasonData = {}; // 시즌별 데이터 저장

            let successCount = 0;

            let totalSeasons = CONFIG.AVAILABLE_SEASONS.length;

            

            showStatusMessage('역대 기록을 불러오는 중...', 'loading');

            showLoadingProgress(0, totalSeasons, '시즌 로딩 중');



            // 배치로 나누어 병렬 처리

            const batches = [];

            for (let i = 0; i < CONFIG.AVAILABLE_SEASONS.length; i += CONFIG.PARALLEL_LOADING.BATCH_SIZE) {

                batches.push(CONFIG.AVAILABLE_SEASONS.slice(i, i + CONFIG.PARALLEL_LOADING.BATCH_SIZE));

            }



            for (const batch of batches) {

                // 각 배치를 병렬로 처리

                const batchPromises = batch.map(season => loadSeasonDataWithRetry(season));

                

                try {

                    const batchResults = await Promise.allSettled(batchPromises);

                    

                    batchResults.forEach(result => {

                        if (result.status === 'fulfilled' && result.value.success) {

                            const { season, data } = result.value;

                            successCount++;

                            

                            // 시즌 데이터 저장

                            seasonData[season] = data;

                            

                            // 경기 데이터 수집

                            allMatches.push(...data.matches.map(match => ({

                                ...match,

                                season: season

                            })));

                            

                            // 선수 통계 누적

                            Object.entries(data.players).forEach(([name, stats]) => {

                                if (!allTimeStats[name]) {

                                    allTimeStats[name] = {

                                        totalAppearances: 0,

                                        totalGoals: 0,

                                        totalMvp: 0

                                    };

                                }

                                

                                allTimeStats[name].totalAppearances += stats.appearances;

                                allTimeStats[name].totalGoals += stats.goals;

                                allTimeStats[name].totalMvp += stats.mvp;

                            });

                        }

                        

                        // 프로그레스 업데이트

                        showLoadingProgress(successCount, totalSeasons, `${successCount}개 시즌 로딩 완료`);

                    });

                    

                } catch (error) {

                    console.error('배치 처리 중 오류:', error);

                }

                

                // 배치 간 잠시 대기 (서버 부하 방지)

                if (batches.indexOf(batch) < batches.length - 1) {

                    await new Promise(resolve => setTimeout(resolve, 100));

                }

            }

            

            hideLoadingProgress();

            

            if (successCount === 0) {

                showStatusMessage('데이터를 불러올 수 없습니다. 인터넷 연결을 확인해주세요.', 'error');

                return { stats: {}, matches: [], records: null };

            } else if (successCount < totalSeasons) {

                showStatusMessage(`${successCount}/${totalSeasons} 시즌 데이터 로딩 완료`, 'success');

                setTimeout(hideStatusMessage, 3000);

            } else {

                hideStatusMessage();

            }

            

            const teamRecords = calculateTeamRecords(allMatches, seasonData);

            return { stats: allTimeStats, matches: allMatches, records: teamRecords };

        }



        // ========== 팀 기록 계산 (최고/아쉬운 시즌 추가) ==========

        function calculateTeamRecords(matches, seasonData) {

            let maxWinStreak = 0;

            let currentWinStreak = 0;

            let winStreakStart = null;

            let winStreakEnd = null;

            let maxWinStreakStart = null;

            let maxWinStreakEnd = null;

            

            let maxLossStreak = 0;

            let currentLossStreak = 0;

            let lossStreakStart = null;

            let lossStreakEnd = null;

            let maxLossStreakStart = null;

            let maxLossStreakEnd = null;

            

            let maxGoalsMatch = null;

            let maxConcededMatch = null;

            

            let totalMatches = 0;

            let wins = 0;

            let draws = 0;

            let losses = 0;

            let goalsFor = 0;

            let goalsAgainst = 0;

            

            // 시즌별 통계 계산

            const seasonStats = {};

            Object.entries(seasonData).forEach(([season, data]) => {

                if (!data || !data.matches || data.matches.length === 0) return;

                

                let seasonWins = 0;

                let seasonDraws = 0;

                let seasonLosses = 0;

                let seasonGoalsFor = 0;

                let seasonGoalsAgainst = 0;

                

                data.matches.forEach(match => {

                    const [gf, ga] = match.score.split(':').map(Number);

                    seasonGoalsFor += gf;

                    seasonGoalsAgainst += ga;

                    

                    if (match.result === 'win') seasonWins++;

                    else if (match.result === 'draw') seasonDraws++;

                    else seasonLosses++;

                });

                

                const seasonTotalMatches = data.matches.length;

                const winRate = seasonTotalMatches > 0 ? (seasonWins / seasonTotalMatches) * 100 : 0;

                

                seasonStats[season] = {

                    matches: seasonTotalMatches,

                    wins: seasonWins,

                    draws: seasonDraws,

                    losses: seasonLosses,

                    goalsFor: seasonGoalsFor,

                    goalsAgainst: seasonGoalsAgainst,

                    winRate: winRate

                };

            });

            

            // 최고 시즌과 아쉬운 시즌 계산

            let bestSeason = null;

            let worstSeason = null;

            let highestWinRate = -1;

            let lowestWinRate = 101;

            

            Object.entries(seasonStats).forEach(([season, stats]) => {

                if (stats.matches >= 5) { // 최소 5경기 이상 치른 시즌만 고려

                    if (stats.winRate > highestWinRate) {

                        highestWinRate = stats.winRate;

                        bestSeason = { season, ...stats };

                    }

                    if (stats.winRate < lowestWinRate) {

                        lowestWinRate = stats.winRate;

                        worstSeason = { season, ...stats };

                    }

                }

            });

            

            const sortedMatches = [...matches].sort((a, b) => new Date(a.date) - new Date(b.date));

            

            sortedMatches.forEach(match => {

                const [gf, ga] = match.score.split(':').map(Number);



                totalMatches++;

                goalsFor += gf;

                goalsAgainst += ga;

                

                if (match.result === 'win') {

                    wins++;

                    if (currentWinStreak === 0) {

                        winStreakStart = match.date;

                    }

                    currentWinStreak++;

                    winStreakEnd = match.date;

                    

                    if (currentWinStreak > maxWinStreak) {

                        maxWinStreak = currentWinStreak;

                        maxWinStreakStart = winStreakStart;

                        maxWinStreakEnd = winStreakEnd;

                    }

                    

                    currentLossStreak = 0;

                } else if (match.result === 'draw') {

                    draws++;

                    currentWinStreak = 0;

                    currentLossStreak = 0;

                } else {

                    losses++;

                    if (currentLossStreak === 0) {

                        lossStreakStart = match.date;

                    }

                    currentLossStreak++;

                    lossStreakEnd = match.date;

                    

                    if (currentLossStreak > maxLossStreak) {

                        maxLossStreak = currentLossStreak;

                        maxLossStreakStart = lossStreakStart;

                        maxLossStreakEnd = lossStreakEnd;

                    }

                    

                    currentWinStreak = 0;

                }

                

                if (!maxGoalsMatch || gf > parseInt(maxGoalsMatch.score.split(':')[0])) {

                    maxGoalsMatch = match;

                }

                

                if (!maxConcededMatch || ga > parseInt(maxConcededMatch.score.split(':')[1])) {

                    maxConcededMatch = match;

                }

            });

            

            return {

                totalMatches,

                wins,

                draws,

                losses,

                goalsFor,

                goalsAgainst,

                maxWinStreak: {

                    count: maxWinStreak,

                    startDate: maxWinStreakStart,

                    endDate: maxWinStreakEnd

                },

                maxLossStreak: {

                    count: maxLossStreak,

                    startDate: maxLossStreakStart,

                    endDate: maxLossStreakEnd

                },

                maxGoalsMatch,

                maxConcededMatch,

                bestSeason,

                worstSeason

            };

        }



        // ========== 역대 기록 관리 ==========

        async function toggleAllTimeView() {

            if (isAllTimeView) {

                isAllTimeView = false;

                

                const seasonSelect = document.getElementById('seasonSelect');

                currentSeason = seasonSelect.value;

                

                document.getElementById('mainContent').style.display = 'grid';

                document.getElementById('allTimeContent').style.display = 'none';

                

                updateButtonStates();

                await loadData();

            } else {

                isAllTimeView = true;

                

                document.getElementById('mainContent').style.display = 'none';

                document.getElementById('allTimeContent').style.display = 'grid';

                

                updateButtonStates();

                

                try {

                    const { stats: allTimeStats, records: teamRecords } = await loadAllTimeSeasonsParallel();

                    updateAllTimeRankings(allTimeStats);

                    updateAllTimeTable(allTimeStats, currentFilter);

                    updateTeamRecords(teamRecords);

                } catch (error) {

                    showStatusMessage('역대 기록을 불러오는 중 오류가 발생했습니다.', 'error');

                    console.error('역대 기록 로딩 오류:', error);

                }

            }

        }



        function updateAllTimeRankings(allTimeStats) {

            const statsOverview = document.querySelector('.stats-overview');

            

            const topScorers = Object.entries(allTimeStats)

                .map(([name, stats]) => ({name, ...stats}))

                .filter(player => player.totalGoals > 0)

                .sort((a, b) => b.totalGoals - a.totalGoals);

            

            const topMvps = Object.entries(allTimeStats)

                .map(([name, stats]) => ({name, ...stats}))

                .filter(player => player.totalMvp > 0)

                .sort((a, b) => {

                    if (b.totalMvp !== a.totalMvp) return b.totalMvp - a.totalMvp;

                    if (b.totalAppearances !== a.totalAppearances) return b.totalAppearances - a.totalAppearances;

                    return koreanCollator.compare(a.name, b.name);

                });

                

            const topAppearances = Object.entries(allTimeStats)

                .map(([name, stats]) => ({name, ...stats}))

                .filter(player => player.totalAppearances > 0)

                .sort((a, b) => b.totalAppearances - a.totalAppearances);

            

            const totalPlayers = Object.keys(allTimeStats).filter(name => 

                allTimeStats[name].totalAppearances > 0

            ).length;

            

            statsOverview.innerHTML = `

                <div class="stat-card all-time-highlight">

                    <div class="stat-title">역대 득점왕</div>

                    <div class="stat-value">${topScorers[0]?.name || '-'}</div>

                    <div class="stat-subtitle">${topScorers[0]?.totalGoals || 0}골</div>

                </div>

                <div class="stat-card all-time-highlight">

                    <div class="stat-title">역대 MVP</div>

                    <div class="stat-value">${topMvps[0]?.name || '-'}</div>

                    <div class="stat-subtitle">${topMvps[0]?.totalMvp || 0}회</div>

                </div>

                <div class="stat-card all-time-highlight">

                    <div class="stat-title">최다 출장</div>

                    <div class="stat-value">${topAppearances[0]?.name || '-'}</div>

                    <div class="stat-subtitle">${topAppearances[0]?.totalAppearances || 0}경기</div>

                </div>

                <div class="stat-card all-time-highlight">

                    <div class="stat-title">등록 선수</div>

                    <div class="stat-value">${totalPlayers}</div>

                    <div class="stat-subtitle">명</div>

                </div>

            `;

        }



        function updateTeamRecords(teamRecords) {

            const container = document.getElementById('teamRecordsContainer');

            

            if (!teamRecords) {

                container.innerHTML = '<div class="no-data">팀 기록 데이터가 없습니다.</div>';

                return;

            }

            

            const formatDate = (dateStr) => {

                const date = new Date(dateStr);

                return date.toLocaleDateString('ko-KR', {

                    year: 'numeric',

                    month: 'short',

                    day: 'numeric'

                });

            };

            

            // 개선된 누적 기록 카드

// updateTeamRecords 함수 내의 누적 기록 카드 부분을 이렇게 수정하세요:



// 개선된 누적 기록 카드

let overallRecordCard = `

    <div class="team-record-card team-record-overall">

        <div class="team-record-title">📊 누적 기록</div>

        <div class="team-record-value" style="font-size: 1.4em;">${teamRecords.totalMatches}전 ${teamRecords.wins}승 ${teamRecords.draws}무 ${teamRecords.losses}패</div>

        <div class="team-record-detail">

            득점 ${teamRecords.goalsFor} / 실점 ${teamRecords.goalsAgainst}

        </div>

    </div>

`;



            container.innerHTML = overallRecordCard + `

                <div class="team-record-card team-record-win-streak">

                    <div class="team-record-title">🔥 최고 연승 기록</div>

                    <div class="team-record-value">${teamRecords.maxWinStreak.count}연승</div>

                    <div class="team-record-detail">

                        ${teamRecords.maxWinStreak.startDate ?

                            `${formatDate(teamRecords.maxWinStreak.startDate)} ~ ${formatDate(teamRecords.maxWinStreak.endDate)}` :

                            '기록 없음'}

                    </div>

                </div>

                

                <div class="team-record-card team-record-loss-streak">

                    <div class="team-record-title">💔 최다 연패 기록</div>

                    <div class="team-record-value">${teamRecords.maxLossStreak.count}연패</div>

                    <div class="team-record-detail">

                        ${teamRecords.maxLossStreak.startDate ?

                            `${formatDate(teamRecords.maxLossStreak.startDate)} ~ ${formatDate(teamRecords.maxLossStreak.endDate)}` :

                            '기록 없음'}

                    </div>

                </div>

                

                <div class="team-record-card team-record-max-goals">

                    <div class="team-record-title">⚽ 최다 득점 경기</div>

                    <div class="team-record-value">${teamRecords.maxGoalsMatch ? teamRecords.maxGoalsMatch.score.split(':')[0] : 0}골</div>

                    <div class="team-record-detail">

                      ${teamRecords.maxGoalsMatch ?

                            `vs ${teamRecords.maxGoalsMatch.opponent}<br>${formatDate(teamRecords.maxGoalsMatch.date)}` :

                            '기록 없음'}

                    </div>

                </div>

                

                <div class="team-record-card team-record-max-conceded">

                    <div class="team-record-title">😱 최다 실점 경기</div>

                    <div class="team-record-value">${teamRecords.maxConcededMatch ? teamRecords.maxConcededMatch.score.split(':')[1] : 0}실점</div>

                    <div class="team-record-detail">

                        ${teamRecords.maxConcededMatch ?

                            `vs ${teamRecords.maxConcededMatch.opponent}<br>${formatDate(teamRecords.maxConcededMatch.date)}` :

                            '기록 없음'}

                    </div>

                </div>

                

                <div class="team-record-card team-record-best-season">

                    <div class="team-record-title">🏆 최고 시즌</div>

                    <div class="team-record-value">${teamRecords.bestSeason ? teamRecords.bestSeason.season : '-'}</div>

                    <div class="team-record-detail">

                        ${teamRecords.bestSeason ?

                            `승률 ${teamRecords.bestSeason.winRate.toFixed(1)}%<br>${teamRecords.bestSeason.wins}승 ${teamRecords.bestSeason.draws}무 ${teamRecords.bestSeason.losses}패` :

                            '기록 없음'}

                    </div>

                </div>

                

                <div class="team-record-card team-record-worst-season">

                    <div class="team-record-title">📉 아쉬운 시즌</div>

                    <div class="team-record-value">${teamRecords.worstSeason ? teamRecords.worstSeason.season : '-'}</div>

                    <div class="team-record-detail">

                        ${teamRecords.worstSeason ?

                            `승률 ${teamRecords.worstSeason.winRate.toFixed(1)}%<br>${teamRecords.worstSeason.wins}승 ${teamRecords.worstSeason.draws}무 ${teamRecords.worstSeason.losses}패` :

                            '기록 없음'}

                    </div>

                </div>

            `;

        }



        function updateAllTimeTable(allTimeStats, sortBy = 'goals') {

            const tbody = document.getElementById('allTimePlayersTableBody');

            tbody.innerHTML = '';



            let playersBySort = Object.entries(allTimeStats)

                .map(([name, stats]) => ({name, ...stats}))

                .filter(player => player.totalAppearances > 0);



            switch(sortBy) {

                case 'goals':

                    playersBySort.sort((a, b) => {

                        if (b.totalGoals !== a.totalGoals) return b.totalGoals - a.totalGoals;

                        if (b.totalAppearances !== a.totalAppearances) return b.totalAppearances - a.totalAppearances;

                        return koreanCollator.compare(a.name, b.name);

                    });

                    break;

                case 'attendance':

                    playersBySort.sort((a, b) => {

                        if (b.totalAppearances !== a.totalAppearances) return b.totalAppearances - a.totalAppearances;

                        if (b.totalGoals !== a.totalGoals) return b.totalGoals - a.totalGoals;

                        return koreanCollator.compare(a.name, b.name);

                    });

                    break;

                case 'mvp':

                    // 개선된 MVP 정렬 기준 적용

                    playersBySort.sort((a, b) => {

                        if (b.totalMvp !== a.totalMvp) return b.totalMvp - a.totalMvp;

                        if (b.totalAppearances !== a.totalAppearances) return b.totalAppearances - a.totalAppearances;

                        return koreanCollator.compare(a.name, b.name);

                    });

                    break;

                default:

                    playersBySort.sort((a, b) => koreanCollator.compare(a.name, b.name));

            }



            if (playersBySort.length === 0) {

                tbody.innerHTML = '<tr><td colspan="4" class="no-data">역대 기록 데이터가 없습니다.</td></tr>';

                return;

            }



            playersBySort.forEach((player, index) => {

                const row = document.createElement('tr');

                

                let rankDisplay = '';

                if (index < 3) {

                    const rankEmoji = ['🥇', '🥈', '🥉'];

                    

                    let showMedal = false;

                    switch(sortBy) {

                        case 'goals':

                            showMedal = player.totalGoals > 0;

                            break;

                        case 'attendance':

                            showMedal = player.totalAppearances > 0;

                            break;

                        case 'mvp':

                            showMedal = player.totalMvp > 0;

                            break;

                        default:

                            showMedal = false;

                    }

                    

                    if (showMedal) {

                        rankDisplay = ` ${rankEmoji[index]}`;

                    }

                }

                

                row.innerHTML = `

                    <td><strong>${player.name}</strong>${rankDisplay}</td>

                    <td><strong>${player.totalAppearances}</strong></td>

                    <td><strong>${player.totalGoals}</strong></td>

                    <td>${player.totalMvp > 0 ? `<span class="mvp-badge">${player.totalMvp}회</span>` : '0'}</td>

                `;

                tbody.appendChild(row);

            });

        }



        // ========== 시즌 데이터 관리 ==========

        async function changeSeason() {

            const seasonSelect = document.getElementById('seasonSelect');

            const newSeason = seasonSelect.value;

            

            if (isAllTimeView || currentSeason !== newSeason) {

                if (isAllTimeView) {

                    isAllTimeView = false;

                    updateButtonStates();

                    

                    document.getElementById('mainContent').style.display = 'grid';

                    document.getElementById('allTimeContent').style.display = 'none';

                }

                

                currentSeason = newSeason;

                await loadData();

            }

        }



        function updateStats() {

            if (matches.length === 0) {

                const statsOverview = document.querySelector('.stats-overview');

                statsOverview.innerHTML = `

                    <div class="stat-card">

                        <div class="stat-title">경기 수</div>

                        <div class="stat-value">0</div>

                        <div class="stat-subtitle">총 경기</div>

                    </div>

                    <div class="stat-card">

                        <div class="stat-title">승률</div>

                        <div class="stat-value">0%</div>

                        <div class="stat-subtitle">0승 0무 0패</div>

                    </div>

                    <div class="stat-card">

                        <div class="stat-title">득점</div>

                        <div class="stat-value">0</div>

                        <div class="stat-subtitle">경기당 0골</div>

                    </div>

                    <div class="stat-card">

                        <div class="stat-title">시즌 MVP</div>

                        <div class="stat-value">-</div>

                        <div class="stat-subtitle">MVP 0회</div>

                    </div>

                `;

                return;

            }

            

            const totalMatches = matches.length;

            const wins = matches.filter(match => match.result === 'win').length;

            const draws = matches.filter(match => match.result === 'draw').length;

            const losses = matches.filter(match => match.result === 'loss').length;

            

            let totalGoalsFor = 0;

            let totalGoalsAgainst = 0;

            

            matches.forEach(match => {

                const [goalsFor, goalsAgainst] = match.score.split(':').map(Number);

                if (!isNaN(goalsFor) && !isNaN(goalsAgainst)) {

                    totalGoalsFor += goalsFor;

                    totalGoalsAgainst += goalsAgainst;

                }

            });

            

            const winRate = totalMatches > 0 ? ((wins / totalMatches) * 100).toFixed(1) : 0;

            const goalsPerMatch = totalMatches > 0 ? (totalGoalsFor / totalMatches).toFixed(1) : 0;

            

            // 시즌 MVP 계산

            const seasonMvpPlayer = calculateSeasonMvp(playerStats);

            const mvpName = seasonMvpPlayer ? seasonMvpPlayer.name : '-';

            const mvpCount = seasonMvpPlayer ? seasonMvpPlayer.mvp : 0;

            const mvpAppearances = seasonMvpPlayer ? seasonMvpPlayer.appearances : 0;

            

            const statsOverview = document.querySelector('.stats-overview');

            statsOverview.innerHTML = `

                <div class="stat-card">

                    <div class="stat-title">경기 수</div>

                    <div class="stat-value">${totalMatches}</div>

                    <div class="stat-subtitle">총 경기</div>

                </div>

                <div class="stat-card">

                    <div class="stat-title">승률</div>

                    <div class="stat-value">${winRate}%</div>

                    <div class="stat-subtitle">${wins}승 ${draws}무 ${losses}패</div>

                </div>

                <div class="stat-card">

                    <div class="stat-title">득점</div>

                    <div class="stat-value">${totalGoalsFor}</div>

                    <div class="stat-subtitle">경기당 ${goalsPerMatch}골</div>

                </div>

                <div class="stat-card">

                    <div class="stat-title">시즌 MVP</div>

                    <div class="stat-value">${mvpName}</div>

                    <div class="stat-subtitle">${mvpCount > 0 ? `MVP ${mvpCount}회, ${mvpAppearances}경기` : 'MVP 0회'}</div>

                </div>

            `;

        }



        async function loadData() {

            try {

                showStatusMessage(`${currentSeason} 시즌 데이터를 불러오는 중...`, 'loading');

                

                if (currentAbortController) {

                    currentAbortController.abort();

                }

                currentAbortController = new AbortController();

                

                const response = await fetch(`${currentSeason}_data.json`, {

                    signal: currentAbortController.signal,

                    headers: {

                        'Cache-Control': 'no-cache'

                    }

                });

                

                if (!response.ok) {

                    throw new Error(`HTTP ${response.status}: 파일을 찾을 수 없습니다.`);

                }

                

                const rawData = await response.json();

                const data = validateSeasonData(rawData);

                

                matches = data.matches || [];

                playerStats = data.players || {};

                

                updateStats();

                updateTable(playerStats, matches, 'playersTableBody', 'players');

                updateTable(matches, [], 'matchesTableBody', 'matches');

                

                hideStatusMessage();

                

            } catch (error) {

                if (error.name !== 'AbortError') {

                    let errorMessage = `${currentSeason} 시즌 데이터를 불러올 수 없습니다.`;

                    

                    if (error.message.includes('404')) {

                        errorMessage += ' (파일이 존재하지 않습니다)';

                    } else if (error.message.includes('Failed to fetch')) {

                        errorMessage += ' (인터넷 연결을 확인해주세요)';

                    } else if (error.name === 'SyntaxError') {

                        errorMessage += ' (파일 형식이 올바르지 않습니다)';

                    }

                    

                    showStatusMessage(errorMessage, 'error');

                    console.error(`${currentSeason} 시즌 데이터 로딩 실패:`, error);

                }

                

                matches = [];

                playerStats = {};

                updateStats();

                updateTable({}, [], 'playersTableBody', 'players');

                updateTable([], [], 'matchesTableBody', 'matches');

            }

        }



        // ========== 통합 테이블 업데이트 함수 (MVP 정렬 개선됨) ==========

        function updateTable(data, matches, tbodyId, type) {

            const tbody = document.getElementById(tbodyId);

            tbody.innerHTML = '';



            if (type === 'players') {

                updatePlayersTableContent(tbody, data, matches);

            } else if (type === 'matches') {

                updateMatchesTableContent(tbody, data);

            }

        }



        function updatePlayersTableContent(tbody, playerStats, matches) {

            if (Object.keys(playerStats).length === 0) {

                tbody.innerHTML = '<tr><td colspan="5" class="no-data">해당 시즌 데이터가 없습니다.</td></tr>';

                return;

            }



            let playersArray = Object.entries(playerStats).map(([name, stats]) => ({

                name,

                ...stats,

                attendanceRate: matches.length > 0 ? ((stats.appearances / matches.length) * 100).toFixed(1) : '0.0'

            }));



            switch(currentFilter) {

                case 'goals':

                    playersArray.sort((a, b) => {

                        if (b.goals !== a.goals) return b.goals - a.goals;

                        if (b.appearances !== a.appearances) return b.appearances - a.appearances;

                        return koreanCollator.compare(a.name, b.name);

                    });

                    break;

                case 'attendance':

                    playersArray.sort((a, b) => {

                        if (b.attendanceRate !== a.attendanceRate) return b.attendanceRate - a.attendanceRate;

                        if (b.goals !== a.goals) return b.goals - a.goals;

                        return koreanCollator.compare(a.name, b.name);

                    });

                    break;

                case 'mvp':

                    // 개선된 MVP 정렬 기준: 1) MVP 횟수 2) 참가횟수

                    playersArray.sort((a, b) => {

                        if (b.mvp !== a.mvp) return b.mvp - a.mvp;

                        if (b.appearances !== a.appearances) return b.appearances - a.appearances;

                        return koreanCollator.compare(a.name, b.name);

                    });

                    break;

                default:

                    playersArray.sort((a, b) => koreanCollator.compare(a.name, b.name));

            }



            playersArray.forEach(player => {

                const row = document.createElement('tr');

                

                let rateClass = 'rate-low';

                if (player.attendanceRate >= 70) rateClass = 'rate-high';

                else if (player.attendanceRate >= 50) rateClass = 'rate-medium';



                row.innerHTML = `

                    <td>${player.name}</td>

                    <td>${player.appearances}</td>

                    <td><span class="attendance-rate ${rateClass}">${player.attendanceRate}%</span></td>

                    <td>${player.goals}</td>

                    <td>${player.mvp > 0 ? `<span class="mvp-badge" title="${player.name} ${player.mvp}회">${player.mvp}회</span>` : '0'}</td>

                `;

                tbody.appendChild(row);

            });

        }



        function updateMatchesTableContent(tbody, matches) {

            if (matches.length === 0) {

                tbody.innerHTML = '<tr><td colspan="5" class="no-data">해당 시즌 경기 기록이 없습니다.</td></tr>';

                return;

            }



            matches.slice(0, 15).forEach(match => {

                const row = document.createElement('tr');

                

                let resultClass = 'result-loss';

                let resultText = '패';

                if (match.result === 'win') {

                    resultClass = 'result-win';

                    resultText = '승';

                } else if (match.result === 'draw') {

                    resultClass = 'result-draw';

                    resultText = '무';

                }



                row.innerHTML = `

                    <td style="white-space: nowrap;">${match.date}</td>

                    <td>${match.opponent}</td>

                    <td><span class="result-badge ${resultClass}">${resultText}</span></td>

                    <td>${match.score}</td>

                    <td>${match.mvp ? `<span class="mvp-badge" title="${match.mvp}">${match.mvp}</span>` : ''}</td>

                `;

                tbody.appendChild(row);

            });

        }



        // ========== 카카오맵 관리 ==========

        function loadKakaoMap() {

            if (mapScriptLoaded) {

                initializeMap();

                return;

            }

            

            const script = document.createElement('script');

            script.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${CONFIG.KAKAO_MAP_API_KEY}&autoload=false&libraries=services`;

            script.onload = function () {

                mapScriptLoaded = true;

                initializeMap();

            };

            

            script.onerror = function () {

                console.error('카카오맵 API 로드 실패');

                document.getElementById('map-placeholder').innerHTML = `

                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#666;">

                        <div>🗺️</div>

                        <div style="margin-top:10px;">${CONFIG.VENUE.name}</div>

                        <div style="font-size:12px;margin-top:5px;">지도를 불러올 수 없습니다</div>

                    </div>

                `;

            };

            document.head.appendChild(script);

        }

        

        function initializeMap() {

            if (mapInitialized) return;

            

            kakao.maps.load(function () {

                const mapContainer = document.getElementById('map-placeholder');

                mapContainer.innerHTML = '<div id="map" style="width:100%;height:300px;border-radius:8px;border:2px solid #1e40af;"></div>';

                

                const map = new kakao.maps.Map(document.getElementById('map'), {

                    center: new kakao.maps.LatLng(37.4656, 127.0347),

                    level: 3

                });



                const geocoder = new kakao.maps.services.Geocoder();



                geocoder.addressSearch(CONFIG.VENUE.address, function (result, status) {

                    if (status === kakao.maps.services.Status.OK) {

                        const coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                        map.setCenter(coords);



                        const marker = new kakao.maps.Marker({

                            map: map,

                            position: coords

                        });



                        const infowindow = new kakao.maps.InfoWindow({

                            content: `<div style="padding:5px;font-size:12px;text-align:center;">${CONFIG.VENUE.name}</div>`

                        });

                        infowindow.open(map, marker);

                        

                        mapInitialized = true;

                    } else {

                        document.getElementById('map').innerHTML = `

                            <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;">

                                주소 검색 실패: ${status}

                            </div>

                        `;

                    }

                });

            });

        }



        // ========== 필터 관리 ==========

        function filterPlayers(filter) {

            currentFilter = filter;

            document.querySelectorAll('.filter-btn').forEach(btn => {

                 btn.classList.toggle('active', btn.dataset.filter === filter);

            });

           

            if (isAllTimeView) {

                loadAllTimeSeasonsParallel().then(({ stats: allTimeStats }) => {

                    updateAllTimeTable(allTimeStats, filter);

                });

            } else {

                updateTable(playerStats, matches, 'playersTableBody', 'players');

            }

        }



        // ========== 초기화 ==========

        function initializeScheduleAndVenue() {

            // 다음 경기 일정 업데이트

            const scheduleItem = document.querySelector('.schedule-item');

            scheduleItem.innerHTML = `

                <div class="schedule-date">${CONFIG.NEXT_MATCH.date}</div>

                <div class="schedule-time-venue">${CONFIG.NEXT_MATCH.venue}</div>

                <div class="schedule-opponent">${CONFIG.NEXT_MATCH.opponent}</div>

            `;



            // 구장 정보 업데이트

            const venueInfo = document.querySelector('.venue-info');

            venueInfo.innerHTML = `

                <div class="venue-name">${CONFIG.VENUE.name}</div>

                <div class="venue-address">📍 ${CONFIG.VENUE.address}</div>

                <div class="venue-phone">📞 ${CONFIG.VENUE.info}</div>

            `;



            // 지도 플레이스홀더 업데이트

            const mapPlaceholder = document.getElementById('map-placeholder');

            mapPlaceholder.innerHTML = `

                🗺️<br>${CONFIG.VENUE.name}<br>

                <small>지도 로딩 중...</small>

            `;

        }



        // ========== 페이지 이벤트 처리 ==========

        window.addEventListener('beforeunload', function() {

            if (currentAbortController) {

                currentAbortController.abort();

            }

        });



        document.addEventListener('DOMContentLoaded', function() {

            // URL 파라미터에서 시즌 확인

            const urlParams = new URLSearchParams(window.location.search);

            const seasonParam = urlParams.get('season');

            

            if (seasonParam && [...CONFIG.AVAILABLE_SEASONS, 'all-time'].includes(seasonParam)) {

                if (seasonParam === 'all-time') {

                    toggleAllTimeView();

                    return;

                } else {

                    currentSeason = seasonParam;

                    document.getElementById('seasonSelect').value = seasonParam;

                }

            }

            

            // 초기화

            updateButtonStates();

            initializeScheduleAndVenue();

            

            // 기본 시즌 데이터 로딩

            loadData();

            

            // 카카오맵은 3초 후 지연 로딩

            setTimeout(loadKakaoMap, 3000);

        });

    </script>

</body>

</html>
