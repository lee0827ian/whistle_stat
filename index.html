<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>휘슬 STAT 관리</title>
  <!-- 기존 CSS 삭망 -->
  <style>
    /* 스타일은 기존 그대로 유지 */
  </style>
</head>
<body>
  <div class="container">
    <!-- 상단 제목/통계 커드 등 기존 구조 유지 -->

    <div class="main-content">
      <div class="section">
        <div class="section-title">선수별 통계</div>
        <div class="filter-controls">
          <button class="filter-btn active" onclick="filterPlayers('all')">전체</button>
          <button class="filter-btn" onclick="filterPlayers('goals')">골 순</button>
          <button class="filter-btn" onclick="filterPlayers('attendance')">참석률 순</button>
          <button class="filter-btn" onclick="filterPlayers('mvp')">MVP 회수</button>
        </div>
        <div class="table-container">
          <table class="players-table">
            <thead>
              <tr>
                <th>이름</th>
                <th>출전</th>
                <th>참석률</th>
                <th>골</th>
                <th>MVP</th>
              </tr>
            </thead>
            <tbody id="playersTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <div class="section-title">최근 경기 결과</div>
        <div class="table-container">
          <table class="matches-table">
            <thead>
              <tr>
                <th>날짜</th>
                <th>상대</th>
                <th>결과</th>
                <th>스코어</th>
                <th>MVP</th>
              </tr>
            </thead>
            <tbody id="matchesTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentFilter = 'all';
    let playerStats = {};

    async function fetchMatchData() {
      const res = await fetch('https://opensheet.vercel.app/14jBB5OzETsvcXAvVZo9bQtHOwMAU91owoGBEdc5zHXw/2025');
      const data = await res.json();

      if (!Array.isArray(data)) {
        console.error('Invalid match data format:', data);
        return;
      }

      const matches = data.map(item => ({
        date: item.날짜,
        opponent: item.상대,
        result: item.결과 === 'O' ? 'win' : item.결과 === '/' ? 'draw' : 'loss',
        score: `${item.득}:${item.실}`,
        mvp: item.MVP || ''
      }));
      renderMatchesTable(matches);
    }

    function renderMatchesTable(matches) {
      const tbody = document.getElementById('matchesTableBody');
      tbody.innerHTML = '';
      matches.slice(0, 15).forEach(match => {
        let resultClass = 'result-loss';
        let resultText = '패';
        if (match.result === 'win') {
          resultClass = 'result-win'; resultText = '승';
        } else if (match.result === 'draw') {
          resultClass = 'result-draw'; resultText = '무';
        }
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${match.date}</td>
          <td>${match.opponent}</td>
          <td><span class="result-badge ${resultClass}">${resultText}</span></td>
          <td>${match.score}</td>
          <td>${match.mvp ? `<span class="mvp-badge">${match.mvp}</span>` : ''}</td>
        `;
        tbody.appendChild(row);
      });
    }

    async function fetchPlayerStats() {
      const res = await fetch('https://opensheet.vercel.app/1eZ0IfSJC2tksg1lwhTrPkwKL8YcQNNWw/2025');
      const data = await res.json();

      if (!Array.isArray(data)) {
        console.error('Invalid player stats data format:', data);
        return;
      }

      playerStats = {};
      data.forEach(row => {
        playerStats[row.이름] = {
          appearances: parseInt(row.출전 || 0),
          goals: parseInt(row.골 || 0),
          mvp: parseInt(row.MVP || 0)
        };
      });
      updatePlayersTable();
    }

    function updatePlayersTable() {
      const tbody = document.getElementById('playersTableBody');
      tbody.innerHTML = '';
      const playersArray = Object.entries(playerStats).map(([name, stats]) => ({
        name,
        ...stats,
        attendanceRate: ((stats.appearances / 28) * 100).toFixed(1)
      }));
      if (currentFilter === 'goals') playersArray.sort((a, b) => b.goals - a.goals);
      else if (currentFilter === 'attendance') playersArray.sort((a, b) => b.attendanceRate - a.attendanceRate);
      else if (currentFilter === 'mvp') playersArray.sort((a, b) => b.mvp - a.mvp);
      else playersArray.sort((a, b) => a.name.localeCompare(b.name));

      playersArray.forEach(player => {
        const row = document.createElement('tr');
        let rateClass = 'rate-low';
        if (player.attendanceRate >= 70) rateClass = 'rate-high';
        else if (player.attendanceRate >= 50) rateClass = 'rate-medium';
        row.innerHTML = `
          <td>${player.name}</td>
          <td>${player.appearances}</td>
          <td><span class="attendance-rate ${rateClass}">${player.attendanceRate}%</span></td>
          <td>${player.goals}</td>
          <td>${player.mvp > 0 ? `<span class="mvp-badge">${player.mvp}회</span>` : '0'}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function filterPlayers(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      updatePlayersTable();
    }

    document.addEventListener('DOMContentLoaded', function () {
      fetchMatchData();
      fetchPlayerStats();
    });
  </script>
</body>
</html>
